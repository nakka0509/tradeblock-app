<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade Block</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- BASE STYLES --- */
        :root {
            /* Light Theme (Default) */
            --bg-color: #F8FAFC;
            --card-bg: #FFFFFF;
            --text-color: #1E293B;
            --text-sub: #64748B;
            --primary: #10B981;
            /* Emerald 500 */
            --danger: #EF4444;
            /* Red 500 */
            --border: #E2E8F0;
            --accent-gold: #D97706;
            /* Amber 600 */
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .dark {
            /* Dark Theme */
            --bg-color: #111827;
            --card-bg: #1F2937;
            --text-color: #F3F4F6;
            --text-sub: #9CA3AF;
            --border: #374151;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        .theme-gold {
            /* Gold Theme (Premium) */
            --bg-color: #000000;
            --card-bg: #000000;
            --text-color: #D4AF37;
            /* Genuine Gold */
            --text-sub: #A3A3A3;
            --primary: #D4AF37;
            --danger: #B91C1C;
            --border: #D4AF37;
            --shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        body {
            background-color: #333;
            /* Outer background */
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            color: var(--text-color);
        }

        /* --- APP CONTAINER --- */
        #app-frame {
            position: relative;
            width: 100%;
            max-width: 400px;
            /* Mobile size */
            height: 100%;
            max-height: 850px;
            background-color: var(--bg-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        @media (min-width: 640px) {
            #app-frame {
                border-radius: 40px;
                height: 90vh;
                border: 8px solid #000;
            }
        }

        .theme-gold #app-frame {
            border-color: #D4AF37;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.4);
        }

        /* --- COMPONENTS --- */
        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: 9999px;
            font-weight: 800;
            text-align: center;
            transition: transform 0.1s active;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            font-size: 1.125rem;
            /* text-lg */
        }

        .btn:active {
            transform: scale(0.96);
        }

        .btn-primary {
            background-color: var(--primary);
            color: #FFFFFF;
        }

        .theme-gold .btn-primary {
            background: linear-gradient(135deg, #FFE082 0%, #B7892B 100%);
            color: #000000;
            text-shadow: none;
            border: 1px solid #FFF;
        }

        .btn-gold {
            background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .theme-gold .btn-gold {
            background: linear-gradient(135deg, #FFE082 0%, #B7892B 100%);
            color: black;
            text-shadow: none;
            border: 1px solid #FFF;
        }

        /* Range Slider Customization */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]:focus {
            outline: none;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: var(--primary);
            margin-top: -10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            cursor: pointer;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            cursor: pointer;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Chart Canvas */
        #bg-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 65%;
            z-index: 0;
            opacity: 0.5;
            pointer-events: none;
        }

        .theme-gold #bg-canvas {
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <div id="app-frame" class="fade-in">
        <!-- CANVAS BACK -->
        <canvas id="bg-canvas"></canvas>

        <!-- HEADER -->
        <header
            class="relative z-10 p-6 flex justify-between items-start bg-gradient-to-b from-[var(--bg-color)] to-transparent pointer-events-none">
            <div class="pointer-events-auto">
                <h1 class="text-3xl font-black italic tracking-tighter leading-tight text-transparent bg-clip-text bg-gradient-to-r from-[var(--text-color)] to-[var(--text-sub)] pr-2 py-1"
                    style="font-family: 'Inter', sans-serif;">TRADE BLOCK</h1>
                <p class="text-sm font-bold opacity-60 mt-0 tracking-widest pl-1">ãƒˆãƒ¬ãƒ¼ãƒ‰ ãƒ–ãƒ­ãƒƒã‚¯</p>
            </div>
            <div class="flex gap-2 pointer-events-auto">
                <button id="btn-lang-ja" onclick="app.setLang('ja')"
                    class="text-sm font-bold px-3 py-2 rounded border border-[var(--border)] bg-[var(--card-bg)] shadow-sm transition">JP</button>
                <button id="btn-lang-en" onclick="app.setLang('en')"
                    class="text-sm font-bold px-3 py-2 rounded border border-[var(--border)] bg-[var(--card-bg)] shadow-sm transition">EN</button>
            </div>
        </header>

        <!-- DEBUG RESET -->
        <button onclick="app.resetData()"
            class="fixed top-28 right-0 bg-red-600 text-white text-xs px-1 py-3 rounded-l-md z-50 hover:bg-red-700 shadow-md font-bold"
            style="writing-mode: vertical-rl;">
            RESET
        </button>

        <!-- MAIN SCROLLABLE CONTENT -->
        <main id="main-content" class="relative z-10 flex-1 overflow-y-auto no-scrollbar p-6 pt-0 pb-28">
            <!-- Dynamic Content -->
        </main>

        <!-- BOTTOM NAVIGATION -->
        <nav
            class="absolute bottom-0 w-full bg-[var(--card-bg)]/95 backdrop-blur-md border-t border-[var(--border)] z-40 pb-8 pt-3 px-6 flex justify-between shadow-lg">
            <button onclick="app.setTab('home')" class="flex flex-col items-center flex-1 gap-1 group nav-btn"
                data-tab="home">
                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition">ğŸ </span>
                <span class="text-xs font-bold mt-1">TIMER</span>
            </button>
            <button onclick="app.setTab('history')" class="flex flex-col items-center flex-1 gap-1 group nav-btn"
                data-tab="history">
                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition">ğŸ“Š</span>
                <span class="text-xs font-bold mt-1">HISTORY</span>
            </button>
            <button onclick="app.setTab('settings')" class="flex flex-col items-center flex-1 gap-1 group nav-btn"
                data-tab="settings">
                <span class="text-3xl filter grayscale group-hover:grayscale-0 transition">âš™ï¸</span>
                <span class="text-xs font-bold mt-1">SETTINGS</span>
            </button>
        </nav>

        <!-- MODAL OVERLAY -->
        <div id="modal-container"
            class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in">
            <!-- Injected Modal Content -->
        </div>
    </div>

    <script>
        /*******************************************************
         * TRADE BLOCK V5 - COMPLETE REWRITE
         * Strict State, Component Rendering, Tick Chart
         *******************************************************/

        const CONSTANTS = {
            DEFAULT_FEE: 500, // as requested
            MIN_FEE: 100,
            MAX_FEE: 100000,
            STEP_FEE: 100,
            SECURE_PROFIT_HOUR: 7 // 7:00 AM
        };

        const I18N = {
            ja: {
                tab_home: "ã‚¿ã‚¤ãƒãƒ¼", tab_history: "å±¥æ­´", tab_settings: "è¨­å®š",
                lock_btn: "ãƒ­ãƒƒã‚¯é–‹å§‹", secure_profit_btn: "å‹ã¡é€ƒã’ (ç¿Œæœ07:00ã¾ã§)",
                time_remain: "æ®‹ã‚Šæ™‚é–“", unlock_fee: "è§£é™¤æ–™",
                history_title: "æ”¯æ‰•ã„å±¥æ­´", no_history: "å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“",
                settings_title: "è¨­å®š", theme: "ãƒ†ãƒ¼ãƒ", blocked_apps: "ãƒ–ãƒ­ãƒƒã‚¯ã‚¢ãƒ—ãƒª", select: "é¸æŠ",
                premium_config: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨­å®š (è§£é™¤æ–™)", premium_title: "ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ—ãƒ©ãƒ³",
                sub_monthly: "æœˆé¡ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ (Â¥1,500)",
                upgrade_cta: "ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦æ©Ÿèƒ½ã‚’è§£æ”¾",
                confirm_title: "æœ€çµ‚ç¢ºèª", confirm_desc: "ä»¥ä¸‹ã®ãƒªã‚¹ã‚¯ã«åŒæ„ã—ã¦ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚",
                chk_risk: "ãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ã¾ã—ãŸ", chk_agree: "åŒæ„ã—ã¦ãƒ­ãƒƒã‚¯ã—ã¾ã™",
                cancel: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", confirm: "æ±ºå®š",
                risk_1: "è¨­å®šæ™‚é–“ã¾ã§ã‚¢ãƒ—ãƒªã‚’ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚", risk_2: "è§£é™¤ã«ã¯è§£é™¤æ–™ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚",
                secure_confirm: "ç¾åœ¨æ™‚åˆ»ã‹ã‚‰ç¿Œæœ07:00ã¾ã§å¼·åˆ¶ãƒ­ãƒƒã‚¯ã—ã¾ã™ã€‚\nè§£é™¤ã§ãã¾ã›ã‚“ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ",
                locked_alert: "ãƒ­ãƒƒã‚¯ä¸­ã¯è¨­å®šã‚’å¤‰æ›´ã§ãã¾ã›ã‚“ã€‚",
                back: "æˆ»ã‚‹", select_apps_title: "ã‚¢ãƒ—ãƒªã‚’é¸æŠ", confirm_selection: "é¸æŠã‚’ç¢ºå®š",
                app_active: "ãƒ–ãƒ­ãƒƒã‚¯æœ‰åŠ¹", save_fee: "è§£é™¤æ–™ã‚’æ›´æ–°", fee_saved: "è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ",
                premium_history_lock: "å±¥æ­´æ©Ÿèƒ½ã¯ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã§ã™",
                // Premium Copy
                premium_headline: "å‹ã¡é€ƒã’ã“ããŒæœ€å¼·ã®è–æ¯",
                premium_subhead: "å¹´é–“åæ”¯ã‚’ãƒ—ãƒ©ã‚¹ã«ã™ã‚‹å”¯ä¸€ã®è¦å¾‹",
                premium_body: "ã€Œã‚ã¨å°‘ã—...ã€ãã®æ¬²ãŒå…¨ã¦ã®åˆ©ç›Šã‚’æº¶ã‹ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿ<br>ãƒ—ãƒ­ã¨æ•—è€…ã®å·®ã¯ã€Œå‹ã¡é€ƒã’ã€ãŒã§ãã‚‹ã‹ã€ãŸã ä¸€ç‚¹ã§ã™ã€‚<br>åˆ©ç›Šç¢ºå®šã®ç¬é–“ã«ç›¸å ´ã‹ã‚‰å¼·åˆ¶éš”é›¢ã•ã‚Œã‚‹ã€‚<br>ã“ã®ã€Œå¼·åˆ¶åŠ›ã€ã•ãˆã‚ã‚Œã°ã€è³‡ç”£ã¯ç¢ºå®Ÿã«ç©ã¿ä¸ŠãŒã‚Šã¾ã™ã€‚",
                premium_roi: "æœˆé¡1,500å††ã¯ã‚³ã‚¹ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã‚ãªãŸã®æ•°ç™¾ä¸‡å††ã®æå¤±ã‚’é˜²ãã€æœ€å¼·ã®æŠ•è³‡ã§ã™ã€‚",
                feat_secure: "æ„Ÿæƒ…ã‚’æ’é™¤ã™ã‚‹ã€Œç¿Œæœã¾ã§ã®é‰„å£ãƒ­ãƒƒã‚¯ã€",
                feat_gold: "æˆåŠŸè€…ã ã‘ãŒçŸ¥ã‚‹ã€Œé»’ã¨é‡‘ã®æ”¯é…è€…ãƒ†ãƒ¼ãƒã€",
                feat_custom: "è¦šæ‚Ÿã‚’æ±ºã‚ã‚‹ã€Œè§£é™¤æ–™ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã€",
                upgrade_now: "è¿½åŠ æ©Ÿèƒ½ã‚’è³¼å…¥",
                mode_timer: "ãƒˆãƒ¬ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯", mode_secure: "å‹ã¡é€ƒã’ãƒ¢ãƒ¼ãƒ‰",
                unlock_title: "ãƒ­ãƒƒã‚¯è§£é™¤", pay_unlock_btn: "æ”¯æ‰•ã£ã¦è§£é™¤", force_unlock: "å¼·åˆ¶è§£é™¤",
                // Legal & Tutorial
                menu_tutorial: "ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’è¦‹ã‚‹", menu_legal: "åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …",
                legal_title: "åˆ©ç”¨è¦ç´„ãƒ»å…è²¬äº‹é …",
                legal_text: `
                    <h4 class="font-bold mb-1">1. å…è²¬äº‹é …</h4>
                    <p class="mb-2 text-sm opacity-80">æœ¬ã‚¢ãƒ—ãƒªã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªå·±è¦å¾‹ã‚’è£œåŠ©ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€æŠ•è³‡åŠ©è¨€ã‚„åˆ©ç›Šã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    <p class="mb-2 text-sm opacity-80">æœ¬ã‚¢ãƒ—ãƒªã®æ©Ÿèƒ½ï¼ˆãƒ­ãƒƒã‚¯æ©Ÿèƒ½ç­‰ï¼‰ã«ã‚ˆã‚Šã€ç‰¹å®šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å–å¼•ãŒã§ããšã€æ©Ÿä¼šæå¤±ã‚„é‡‘éŠ­çš„æå¤±ãŒç™ºç”Ÿã—ãŸå ´åˆã§ã‚‚ã€é–‹ç™ºè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
                    
                    <h4 class="font-bold mb-1">2. å¼·åˆ¶è§£é™¤ã¨è²»ç”¨</h4>
                    <p class="mb-2 text-sm opacity-80">ãƒ­ãƒƒã‚¯ä¸­ã®å¼·åˆ¶è§£é™¤ã«ã¯ã€è¨­å®šã•ã‚ŒãŸè§£é™¤æ–™ï¼ˆãƒšãƒŠãƒ«ãƒ†ã‚£ï¼‰ãŒå¿…è¦ã§ã™ã€‚ã“ã‚Œã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®è‡ªå·±ç®¡ç†ã®ãŸã‚ã®æ©Ÿèƒ½ã§ã‚ã‚Šã€ç·Šæ€¥æ™‚ã§ã‚ã£ã¦ã‚‚è§£é™¤ã«ã¯æ‰€å®šã®æ‰‹ç¶šããŒå¿…è¦ã§ã™ã€‚</p>
                    
                    <h4 class="font-bold mb-1">3. å¥åº·ä¸Šã®æ³¨æ„</h4>
                    <p class="mb-2 text-sm opacity-80">éåº¦ãªã‚¹ãƒˆãƒ¬ã‚¹ã‚„ä¾å­˜ã‚’æ„Ÿã˜ã‚‹å ´åˆã¯ã€ç›´ã¡ã«ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’ä¸­æ­¢ã—ã€å°‚é–€æ©Ÿé–¢ã¸ç›¸è«‡ã—ã¦ãã ã•ã„ã€‚</p>
                `,
                tutorial_title: "ã‚ˆã†ã“ãã€Trade Blockã¸",
                tutorial_step1_title: "è¦å¾‹ã‚’å®ˆã‚‹",
                tutorial_step1_desc: "æ„Ÿæƒ…çš„ãªãƒˆãƒ¬ãƒ¼ãƒ‰ã¯è³‡ç”£ã‚’æº¶ã‹ã—ã¾ã™ã€‚ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ç‰©ç†çš„ã«ã‚¢ãƒ—ãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’é®æ–­ã—ã€å†·é™ã•ã‚’å–ã‚Šæˆ»ã•ã›ã¾ã™ã€‚",
                tutorial_step2_title: "å‹ã¡é€ƒã’ãƒ¢ãƒ¼ãƒ‰",
                tutorial_step2_desc: "åˆ©ç›ŠãŒå‡ºãŸã‚‰å³åº§ã«ãƒ­ãƒƒã‚¯ã€‚ç¿Œæœã¾ã§å¼·åˆ¶çš„ã«å¸‚å ´ã‹ã‚‰é›¢ã‚Œã‚‹ã“ã¨ã§ã€åˆ©ç›Šã‚’ç¢ºå®Ÿã«ç©ã¿ä¸Šã’ã¾ã™ã€‚",
                tutorial_step3_title: "è‡ªå·±è²¬ä»»",
                tutorial_step3_desc: "ãƒ­ãƒƒã‚¯ä¸­ã¯ä¸€åˆ‡ã®æ“ä½œãŒã§ãã¾ã›ã‚“ã€‚ã“ã®ãƒªã‚¹ã‚¯ã‚’ç†è§£ã—ãŸä¸Šã§ã€è¦å¾‹ã‚ã‚‹ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚",
                start_btn: "å§‹ã‚ã‚‹"
            },
            en: {
                tab_home: "TIMER", tab_history: "HISTORY", tab_settings: "SETTINGS",
                lock_btn: "LOCK", secure_profit_btn: "SECURE PROFIT (Until 7AM)",
                time_remain: "Time Remaining", unlock_fee: "Unlock Fee",
                history_title: "Payment History", no_history: "No History",
                settings_title: "Settings", theme: "Theme", blocked_apps: "Blocked Apps", select: "Select",
                premium_config: "Premium Config (Unlock Fee)", premium_title: "Premium Plan",
                sub_monthly: "Monthly Subscription ($10)",
                upgrade_cta: "Upgrade to unlock features",
                confirm_title: "Final Check", confirm_desc: "Agree to risks to proceed.",
                chk_risk: "I understand the risks", chk_agree: "I agree to lock",
                cancel: "Cancel", confirm: "Confirm",
                risk_1: "Cannot access apps until timer ends.", risk_2: "Fee required to unlock early.",
                secure_confirm: "Lock app until 7:00 AM tomorrow?\nThis cannot be undone.",
                locked_alert: "Settings cannot be changed while locked.",
                back: "Back", select_apps_title: "Select Apps", confirm_selection: "Confirm Selection",
                app_active: "Active", save_fee: "Update Fee", fee_saved: "Settings Saved",
                premium_history_lock: "History is Premium Only",
                // EN Copy (Simplified fallback)
                premium_headline: "The Holy Grail of Trading",
                premium_subhead: "Discipline is the only way to win.",
                premium_body: "Greed destroys profits. The difference between pros and amateurs is knowing when to stop.<br>Force yourself away from the market after a win.",
                premium_roi: "$10/mo is not a cost. It's an investment to save thousands.",
                feat_secure: "Ironclad Lock until next morning",
                feat_gold: "Exclusive Gold Theme for Winners",
                feat_custom: "Custom Unlock Fee for Commitment",
                upgrade_now: "GET DISCIPLINE NOW",
                mode_timer: "Timer Lock", mode_secure: "Secure Profit",
                unlock_title: "UNLOCK", pay_unlock_btn: "PAY & UNLOCK", force_unlock: "Force Unlock",
                // Legal & Tutorial EN
                menu_tutorial: "Show Tutorial", menu_legal: "Terms & Disclaimer",
                legal_title: "Terms & Disclaimer",
                legal_text: `
                    <h4 class="font-bold mb-1">1. Disclaimer</h4>
                    <p class="mb-2 text-sm opacity-80">This app is a discipline tool and does not guarantee profits. Not financial advice.</p>
                    <p class="mb-2 text-sm opacity-80">The developer is not liable for any losses (financial or opportunity) caused by the inability to trade during a lock.</p>
                    
                    <h4 class="font-bold mb-1">2. Force Unlock</h4>
                    <p class="mb-2 text-sm opacity-80">Unlocking early requires a fee. This is a self-imposed penalty.</p>
                `,
                tutorial_title: "Welcome to Trade Block",
                tutorial_step1_title: "Discipline First",
                tutorial_step1_desc: "Emotional trading destroys wealth. Block access to regain coool.",
                tutorial_step2_title: "Secure Profit",
                tutorial_step2_desc: "Lock immediately after a win. Force yourself away until tomorrow.",
                tutorial_step3_title: "Your Responsibility",
                tutorial_step3_desc: "No access during lock. Use with understanding of risks.",
                start_btn: "Get Started"
            }
        };

        class TradeGuardApp {
            constructor() {
                // --- STATE ---
                this.state = {
                    lang: 'ja', // Default
                    tab: 'home',
                    page: 'main', // 'main' or 'apps'
                    homeMode: 'timer', // 'timer' or 'secure' (v6.2)
                    isPremium: false,
                    isLocked: false,
                    lockEndTime: null,
                    fee: CONSTANTS.DEFAULT_FEE,
                    duration: 60, // mins
                    theme: 'light',
                    history: [],
                    hasSeenTutorial: false
                };

                // --- RUNTIME ---
                this.timerInterval = null;
                this.chartInterval = null;
                this.candles = [];

                this.init();
            }

            init() {
                // Load from LocalStorage
                try {
                    const saved = localStorage.getItem('tradeblock_v5');
                    if (saved) this.state = { ...this.state, ...JSON.parse(saved) };
                } catch (e) { console.error(e); }

                // Validation
                if (this.state.isLocked) {
                    if (Date.now() > this.state.lockEndTime) {
                        this.unlock(true); // Silent unlock if expired while closed
                    }
                }

                // Initial Apply
                this.applyTheme(this.state.theme);
                this.setLang(this.state.lang); // Apply UI text
                this.startTimer();
                this.initChart();

                // Show tutorial if first time
                if (!this.state.hasSeenTutorial) {
                    this.showTutorial();
                }

                this.render();
            }

            save() {
                localStorage.setItem('tradeblock_v5', JSON.stringify(this.state));
            }

            resetData() {
                if (confirm("DEBUG: Reset all data?")) {
                    localStorage.clear();
                    location.reload();
                }
            }

            t(key) {
                return I18N[this.state.lang][key] || key;
            }

            // --- LOGIC ---

            startTimer() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (this.state.isLocked) {
                        const now = Date.now();
                        const diff = this.state.lockEndTime - now;
                        if (diff <= 0) {
                            this.unlock();
                        } else {
                            this.updateTimerUI(diff);
                        }
                    }
                }, 1000);
            }

            unlock(silent = false) {
                this.state.isLocked = false;
                this.state.lockEndTime = null;
                this.save();
                this.render();
                if (!silent) alert("UNLOCKED / æ™‚é–“çµŒéã«ã‚ˆã‚Šè§£é™¤ã•ã‚Œã¾ã—ãŸ");
            }

            applyTheme(theme) {
                const root = document.documentElement;
                root.className = '';
                if (theme === 'dark') root.classList.add('dark');
                if (theme === 'gold') root.classList.add('theme-gold');
            }

            // --- ACTIONS ---

            setLang(lang) {
                this.state.lang = lang;

                // Smart Currency Conversion (Approx)
                if (lang === 'en') {
                    if (this.state.fee >= 100) this.state.fee = Math.max(5, Math.floor(this.state.fee / 100)); // JPY to USD
                } else {
                    if (this.state.fee < 100) this.state.fee = Math.max(500, this.state.fee * 100); // USD to JPY
                }

                this.save();
                this.render();
            }

            setHomeMode(mode) {
                this.state.homeMode = mode;
                this.render();
            }

            setTab(tab) {
                this.state.tab = tab;
                this.state.page = 'main'; // Reset sub-page
                this.save();
                this.render();
            }

            setPage(page) {
                this.state.page = page;
                this.render();
            }

            toggleTheme(theme) {
                if (theme === 'gold' && !this.state.isPremium) {
                    this.showPremiumModal();
                    return;
                }
                this.state.theme = theme;
                this.applyTheme(theme);
                this.save();
                this.render();
            }

            updateFeeDisplay(val) {
                // Just update display, do not save to state yet
                const el = document.getElementById('fee-display');
                if (el) {
                    const cur = this.state.lang === 'ja' ? 'Â¥' : '$';
                    el.innerText = cur + parseInt(val).toLocaleString();
                }
            }

            saveFee() {
                const slider = document.getElementById('fee-slider');
                if (slider) {
                    this.state.fee = parseInt(slider.value);
                    this.save();
                    alert(this.t('fee_saved'));
                    this.render();
                }
            }

            // --- CHART ---

            initChart() {
                const canvas = document.getElementById('bg-canvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                let width, height;

                const resize = () => {
                    width = canvas.parentElement.offsetWidth;
                    height = canvas.parentElement.offsetHeight * 0.7; // Cover top 70%
                    canvas.width = width;
                    canvas.height = height;
                };
                window.addEventListener('resize', resize);
                resize();

                // Initialize Candles
                this.candles = [];
                let price = 100;
                for (let i = 0; i < 30; i++) {
                    const move = (Math.random() - 0.5) * 5;
                    this.candles.push({
                        open: price, close: price + move,
                        high: price + Math.abs(move) + 1, low: price - Math.abs(move) - 1
                    });
                    price += move;
                }

                // Tick Logic (3s Candle)
                let lastCandleTime = Date.now();
                const CANDLE_DURATION = 3000;
                let currentCandle = { ...this.candles[this.candles.length - 1] };

                const tick = () => {
                    const now = Date.now();

                    // New Candle
                    if (now - lastCandleTime >= CANDLE_DURATION) {
                        this.candles.push(currentCandle);
                        if (this.candles.length > 40) this.candles.shift();
                        lastCandleTime = now;
                        const start = currentCandle.close;
                        currentCandle = { open: start, close: start, high: start, low: start };
                    }

                    // Price Movement
                    const volatility = 0.5;
                    const change = (Math.random() - 0.5) * volatility;
                    currentCandle.close += change;
                    if (currentCandle.close > currentCandle.high) currentCandle.high = currentCandle.close;
                    if (currentCandle.close < currentCandle.low) currentCandle.low = currentCandle.close;

                    this.drawChart(ctx, width, height, [...this.candles, currentCandle]);
                    requestAnimationFrame(tick);
                };
                tick();
            }

            drawChart(ctx, w, h, data) {
                ctx.clearRect(0, 0, w, h);
                let min = Infinity, max = -Infinity;
                data.forEach(c => {
                    if (c.low < min) min = c.low;
                    if (c.high > max) max = c.high;
                });
                const range = max - min || 1;
                const gap = 6;
                const candleW = (w - (data.length * gap)) / data.length;
                const isGold = this.state.theme === 'gold';
                const upColor = isGold ? '#D4AF37' : '#10B981';
                const downColor = isGold ? '#78350F' : '#EF4444';

                data.forEach((c, i) => {
                    const x = i * (candleW + gap);
                    const yOpen = h - ((c.open - min) / range) * h * 0.8 - (h * 0.1);
                    const yClose = h - ((c.close - min) / range) * h * 0.8 - (h * 0.1);
                    const yHigh = h - ((c.high - min) / range) * h * 0.8 - (h * 0.1);
                    const yLow = h - ((c.low - min) / range) * h * 0.8 - (h * 0.1);
                    const color = c.close >= c.open ? upColor : downColor;

                    ctx.strokeStyle = color; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(x + candleW / 2, yHigh); ctx.lineTo(x + candleW / 2, yLow); ctx.stroke();
                    ctx.fillStyle = color;
                    ctx.fillRect(x, Math.min(yOpen, yClose), candleW, Math.max(1, Math.abs(yClose - yOpen)));
                });
            }

            // --- RENDERING ---

            render() {
                // Update Lang Buttons
                document.getElementById('btn-lang-ja').style.opacity = this.state.lang === 'ja' ? '1' : '0.5';
                document.getElementById('btn-lang-en').style.opacity = this.state.lang === 'en' ? '1' : '0.5';

                // Update Bottom Nav
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (this.state.page === 'apps') {
                        // Keep 'settings' highlighted if in apps page, or none? 
                        // Usually apps page is sub-page of settings.
                        btn.style.opacity = '0.5';
                    } else {
                        const isActive = btn.dataset.tab === this.state.tab;
                        btn.style.opacity = isActive ? '1' : '0.5';
                        if (isActive) btn.classList.add('text-[var(--primary)]');
                        else btn.classList.remove('text-[var(--primary)]');
                    }
                    // Update Text
                    const label = btn.querySelector('span:last-child');
                    if (label) label.innerText = this.t('tab_' + btn.dataset.tab);
                });

                // Main Content
                const main = document.getElementById('main-content');
                main.innerHTML = '';

                if (this.state.page === 'apps') {
                    main.appendChild(this.renderAppsPage());
                } else if (this.state.tab === 'home') {
                    main.appendChild(this.renderHome());
                } else if (this.state.tab === 'history') {
                    main.appendChild(this.renderHistory());
                } else if (this.state.tab === 'settings') {
                    main.appendChild(this.renderSettings());
                }
            }

            renderHome() {
                const div = document.createElement('div');
                div.className = "flex flex-col h-full justify-start pb-4 space-y-4 fade-in pt-2";

                // Mode Switcher (Tabs)
                if (!this.state.isLocked) {
                    div.innerHTML += `
                        <div class="flex p-1 bg-[var(--card-bg)] rounded-xl border border-[var(--border)] mx-2 mb-2 shadow-sm">
                            <button onclick="app.setHomeMode('timer')" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${this.state.homeMode === 'timer' ? 'bg-[var(--text-color)] text-[var(--bg-color)] shadow-md' : 'opacity-60'}">
                                â± ${this.t('mode_timer')}
                            </button>
                            <button onclick="app.setHomeMode('secure')" class="flex-1 py-2 text-sm font-bold rounded-lg transition ${this.state.homeMode === 'secure' ? 'bg-gradient-to-r from-amber-400 to-amber-600 text-white shadow-md' : 'opacity-60'}">
                                ğŸ† ${this.t('mode_secure')}
                            </button>
                        </div>
                    `;
                }

                // SECURE PROFIT MODE
                if (this.state.homeMode === 'secure' && !this.state.isLocked) {
                    div.innerHTML += `
                        <div class="flex-1 flex flex-col items-center justify-center text-center px-4 space-y-6">
                            <div class="w-40 h-40 rounded-full bg-gradient-to-br from-amber-300 to-amber-600 flex items-center justify-center shadow-2xl animate-pulse">
                                <span class="text-6xl">ğŸ†</span>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black mb-2 text-[var(--accent-gold)]">${this.t('secure_profit_btn')}</h2>
                                <p class="font-bold opacity-70 text-sm leading-relaxed">
                                    ${this.t('premium_subhead')}
                                </p>
                            </div>
                            
                            ${this.state.isPremium ? `
                                <button onclick="app.triggerSecureProfit()" class="btn btn-gold w-full text-xl py-6 shadow-2xl border-2 border-white/20">
                                    EXECUTE LOCK
                                </button>
                                <p class="text-xs opacity-50 font-bold mt-2">Target: Tomorrow 07:00 AM</p>
                            ` : `
                                <div class="bg-[var(--card-bg)] p-6 rounded-2xl border border-[var(--border)] w-full shadow-lg">
                                    <p class="text-sm font-bold opacity-60 mb-4">PREMIUM ONLY</p>
                                    <button onclick="app.showPremiumModal()" class="btn btn-primary w-full shadow-xl">
                                        ${this.t('upgrade_cta')}
                                    </button>
                                </div>
                            `}
                        </div>
                     `;
                    return div;
                }

                // TIMER MODE (Default)
                const circleColor = this.state.isLocked ? 'var(--danger)' : 'var(--primary)';

                div.innerHTML += `
                    <div class="flex-1 flex flex-col items-center justify-center relative min-h-[280px]">
                        <div class="relative w-72 h-72 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="144" cy="144" r="130" stroke="var(--border)" stroke-width="12" fill="none" opacity="0.3"></circle>
                                <circle id="timer-circle" cx="144" cy="144" r="130" stroke="${circleColor}" stroke-width="12" fill="none"
                                    stroke-dasharray="816" stroke-dashoffset="0" style="transition: stroke-dashoffset 1s linear;"></circle>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span id="timer-text" class="text-5xl font-black tabular-nums tracking-tighter" style="font-family: 'Inter', sans-serif;">
                                    ${this.state.isLocked ? "--:--" : this.formatDuration(this.state.duration)}
                                </span>
                                <span class="text-sm font-bold opacity-60 mt-2 tracking-widest uppercase">${this.t('time_remain')}</span>
                            </div>
                        </div>
                    </div>

                    ${!this.state.isLocked ? `
                        <!-- Slider -->
                        <div class="bg-[var(--card-bg)]/80 backdrop-blur rounded-2xl p-6 border border-[var(--border)] shadow-lg mx-2">
                            <input type="range" min="5" max="1440" step="5" value="${this.state.duration}" 
                                oninput="app.setDuration(this.value)" class="w-full">
                            <div class="flex justify-between text-xs font-bold opacity-60 mt-2 px-1">
                                <span>5m</span><span>24h</span>
                            </div>
                        </div>
                        
                        <!-- Lock Button -->
                        <div class="px-2 pb-4">
                            <button onclick="app.showLockConfirm()" class="btn btn-primary shadow-xl text-xl py-5">
                                ğŸ”’ ${this.t('lock_btn')}
                            </button>
                        </div>
                    ` : `
                        <!-- Unlock Button -->
                        <div class="px-2 space-y-4 pb-4">
                            <div class="p-4 bg-red-500/10 border border-red-500 rounded-xl text-center">
                                <p class="text-red-500 font-bold text-lg animate-pulse">LOCKED</p>
                            </div>
                            <button onclick="app.showPaymentModal()" class="btn bg-gray-800 text-white shadow-xl py-5 text-xl">
                                ğŸ”“ ${this.t('force_unlock')}
                            </button>
                        </div>
                    `}
                `;
                return div;
            }

            renderHistory() {
                const div = document.createElement('div');
                div.className = "space-y-4 fade-in pt-6";
                const total = this.state.history.reduce((a, b) => a + b.amount, 0);
                const cur = this.state.lang === 'ja' ? 'Â¥' : '$';

                // Premium Lock
                if (!this.state.isPremium) {
                    div.innerHTML = `
                        <h2 class="text-3xl font-bold px-2 mb-4">${this.t('history_title')}</h2>
                        <div class="card p-8 text-center flex flex-col items-center justify-center gap-4 border-2 border-[var(--accent-gold)] border-dashed bg-black/5">
                            <span class="text-5xl">ğŸ”’</span>
                            <p class="font-bold text-lg opacity-80">${this.t('premium_history_lock')}</p>
                            <button onclick="app.showPremiumModal()" class="btn btn-primary mt-4 py-4 px-8 shadow-xl">
                                ${this.t('upgrade_cta')}
                            </button>
                        </div>
                    `;
                    return div;
                }

                div.innerHTML = `
                    <div class="flex justify-between items-end px-2 mb-2">
                        <h2 class="text-3xl font-bold">${this.t('history_title')}</h2>
                        <span class="text-4xl font-black text-[var(--primary)]">${cur}${total.toLocaleString()}</span>
                    </div>
                    <div class="space-y-3">
                        ${this.state.history.length === 0 ? `<p class="text-center opacity-50 py-10 font-bold text-xl">${this.t('no_history')}</p>` : ''}
                        ${this.state.history.map(item => `
                            <div class="card flex justify-between items-center py-4 px-6">
                                <span class="font-bold text-lg opacity-80">${item.date.split(' ')[0]}</span>
                                <span class="font-black text-2xl">${cur}${item.amount.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                return div;
            }

            renderSettings() {
                const div = document.createElement('div');
                div.className = "space-y-6 fade-in pt-6 pb-20";

                const cur = this.state.lang === 'ja' ? 'Â¥' : '$';
                const themes = ['light', 'dark', 'gold'];

                // Helper for button classes
                const getThemeBtnClass = (t) => {
                    const active = this.state.theme === t;
                    let cls = "flex-1 py-4 text-lg font-bold rounded-xl border border-[var(--border)] transition shadow-sm ";
                    if (t === 'gold') cls += "bg-gradient-to-r from-amber-200 to-amber-500 text-black ";
                    else cls += active ? "bg-[var(--text-color)] text-[var(--bg-color)] " : "bg-[var(--card-bg)] text-[var(--text-color)] ";
                    return cls;
                };

                const disabled = this.state.isLocked || !this.state.isPremium;
                const min = this.state.lang === 'ja' ? 100 : 5; // Updated Min
                const max = this.state.lang === 'ja' ? 100000 : 1000;
                const step = this.state.lang === 'ja' ? 100 : 5;

                div.innerHTML = `
                    <h2 class="text-3xl font-bold px-2 mb-2">${this.t('settings_title')}</h2>

                    <!-- Theme -->
                    <div class="card">
                        <p class="text-sm font-bold opacity-60 mb-3 uppercase tracking-wider">${this.t('theme')}</p>
                        <div class="flex gap-3">
                            ${themes.map(t => `<button onclick="app.toggleTheme('${t}')" class="${getThemeBtnClass(t)}">${t.toUpperCase()}</button>`).join('')}
                        </div>
                    </div>

                    <!-- Block Apps Link -->
                    <div class="card cursor-pointer hover:opacity-90 active:scale-95 transition" onclick="app.setPage('apps')">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-bold text-xl mb-1">${this.t('blocked_apps')}</p>
                                <p class="text-sm opacity-60">${this.t('select')}</p>
                            </div>
                            <span class="text-4xl">ğŸ“±</span>
                        </div>
                    </div>

                    <!-- Premium Config -->
                    <div class="card relative overflow-hidden ${disabled ? 'opacity-60 grayscale' : ''}">
                         ${!this.state.isPremium ? `
                            <div class="absolute inset-0 z-20 flex items-center justify-center cursor-pointer bg-white/5 backdrop-blur-[2px]" onclick="app.showPremiumModal()">
                                <span class="bg-black text-[#D4AF37] px-4 py-2 rounded-full text-sm font-bold shadow-2xl scale-110">ğŸ”’ Premium Only</span>
                            </div>
                        ` : ''}
                        <div class="flex justify-between items-center mb-6">
                            <p class="text-sm font-bold opacity-60 uppercase tracking-wider">${this.t('premium_config')}</p>
                            <p class="text-3xl font-black text-[var(--accent-gold)]" id="fee-display">${cur}${this.state.fee.toLocaleString()}</p>
                        </div>
                        <div class="px-2 mb-4">
                             <input id="fee-slider" type="range" min="${min}" max="${max}" step="${step}" value="${this.state.fee}" 
                                oninput="app.updateFeeDisplay(this.value)" ${disabled ? 'disabled' : ''}>
                        </div>
                        
                        ${!disabled ? `
                            <button onclick="app.saveFee()" class="w-full py-3 rounded-xl bg-[var(--text-color)] text-[var(--bg-color)] font-bold shadow-md active:scale-95 transition">
                                ${this.t('save_fee')}
                            </button>
                        ` : ''}

                        ${this.state.isLocked ? `<p class="text-sm text-red-500 text-right mt-2 font-bold">${this.t('locked_alert')}</p>` : ''}
                    </div>

                    <!-- Info Menu -->
                    <div class="bg-[var(--card-bg)] rounded-xl overflow-hidden border border-[var(--border)] shadow-sm">
                        <button onclick="app.showTutorial()" class="w-full p-4 text-left font-bold flex justify-between items-center border-b border-[var(--border)] active:bg-[var(--bg-color)]">
                            <span>ğŸ“š ${this.t('menu_tutorial')}</span>
                            <span class="opacity-50">â€º</span>
                        </button>
                        <button onclick="app.showLegal()" class="w-full p-4 text-left font-bold flex justify-between items-center active:bg-[var(--bg-color)]">
                            <span>âš–ï¸ ${this.t('menu_legal')}</span>
                            <span class="opacity-50">â€º</span>
                        </button>
                    </div>

                    <!-- Premium Banner -->
                    ${!this.state.isPremium ? `
                        <div onclick="app.showPremiumModal()" class="mt-2 bg-gradient-to-br from-[#111] to-[#333] p-8 rounded-2xl shadow-xl text-center border border-gray-700 cursor-pointer">
                            <p class="text-4xl mb-3">ğŸ’</p>
                            <h3 class="text-[#D4AF37] font-black text-2xl mb-2">${this.t('premium_title')}</h3>
                            <p class="text-gray-400 font-bold">${this.t('upgrade_cta')}</p>
                        </div>
                    ` : ''}
                `;
                return div;
            }

            renderAppsPage() {
                const div = document.createElement('div');
                div.className = "flex flex-col h-full fade-in pb-20";
                div.innerHTML = `
                    <div class="flex items-center gap-4 mb-8 pt-4 px-2">
                        <button onclick="app.setPage('main')" class="w-12 h-12 rounded-full bg-[var(--card-bg)] border border-[var(--border)] flex items-center justify-center shadow-sm hover:scale-105 transition">
                            <span class="text-2xl font-bold">â†</span>
                        </button>
                        <h2 class="text-3xl font-black">${this.t('select_apps_title')}</h2>
                    </div>

                    <div class="space-y-4 overflow-y-auto px-1">
                        ${this.renderAppItem('MetaTrader 4', 'MetaQuotes', 'blue-500', 'MT4')}
                        ${this.renderAppItem('TradingView', 'TradingView Inc.', 'black', 'TV')}
                        ${this.renderAppItem('X / Twitter', 'Social', 'green-500', 'X')}
                        ${this.renderAppItem('Instagram', 'Social', 'pink-500', 'IG')}
                    </div>

                    <div class="fixed bottom-8 left-6 right-6 z-50">
                        <button onclick="app.setPage('main')" class="btn btn-primary shadow-2xl py-4 text-xl border-2 border-white">
                            ${this.t('confirm_selection')}
                        </button>
                    </div>
                `;
                return div;
            }

            renderAppItem(name, sub, color, icon) {
                return `
                <div class="card flex justify-between items-center group cursor-pointer border-l-4 border-l-[var(--primary)] hover:translate-x-1 transition">
                    <div class="flex items-center gap-5">
                        <div class="w-14 h-14 rounded-2xl bg-${color} flex items-center justify-center text-white font-bold text-xl shadow-md">
                            ${icon}
                        </div>
                        <div>
                            <p class="font-bold text-xl text-[var(--text-color)]">${name}</p>
                            <p class="text-sm opacity-60">${sub}</p>
                        </div>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-[var(--primary)] flex items-center justify-center text-white font-bold shadow-sm">âœ“</div>
                </div>`;
            }

            // --- MODALS ---

            showLockConfirm() {
                const cur = this.state.lang === 'ja' ? 'Â¥' : '$';
                this.showModal(`
                    <h3 class="text-2xl font-black mb-4">${this.t('confirm_title')}</h3>
                    <p class="opacity-70 mb-6 font-bold leading-relaxed">${this.t('confirm_desc')}</p>
                    <div class="space-y-4 bg-[var(--bg-color)] p-4 rounded-xl mb-6">
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸš«</span>
                            <span class="font-bold text-sm">${this.t('risk_1')}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-2xl">ğŸ’¸</span>
                            <span class="font-bold text-sm">${this.t('risk_2')} <br><span class="text-[var(--danger)]">(${this.t('unlock_fee')}: ${cur}${this.state.fee.toLocaleString()})</span></span>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="app.closeModal()" class="flex-1 py-4 font-bold opacity-60 hover:opacity-100 transition">${this.t('cancel')}</button>
                        <button onclick="app.confirmLock()" class="flex-1 py-4 bg-[var(--danger)] text-white font-bold rounded-xl shadow-lg hover:scale-105 transition">${this.t('confirm')}</button>
                    </div>
                `);
            }

            confirmLock() {
                this.state.lockEndTime = Date.now() + (this.state.duration * 60 * 1000);
                this.state.isLocked = true;
                this.save();
                this.closeModal();
                this.render();
            }

            triggerSecureProfit() {
                if (!this.state.isPremium) {
                    this.showPremiumModal();
                    return;
                }
                if (confirm(this.t('secure_confirm'))) {
                    // Calc next 7AM
                    const now = new Date();
                    let target = new Date();
                    target.setHours(CONSTANTS.SECURE_PROFIT_HOUR, 0, 0, 0);
                    if (now >= target) target.setDate(target.getDate() + 1);

                    this.state.lockEndTime = target.getTime();
                    this.state.isLocked = true;
                    this.save();
                    this.render();
                }
            }

            showPaymentModal() {
                const cur = this.state.lang === 'ja' ? 'Â¥' : '$';
                this.showModal(`
                    <h3 class="text-3xl font-black mb-2 text-center">ğŸ”“ ${this.t('unlock_title')}</h3>
                    <p class="text-center opacity-60 mb-8 font-bold">${this.t('unlock_fee')}</p>
                    
                    <div class="text-center mb-8">
                        <span class="text-5xl font-black text-[var(--danger)]">${cur}${this.state.fee.toLocaleString()}</span>
                    </div>

                    <button onclick="app.processPayment()" class="btn bg-[var(--text-color)] text-[var(--bg-color)] py-5 text-xl shadow-xl">
                        ${this.t('pay_unlock_btn')}
                    </button>
                    <button onclick="app.closeModal()" class="mt-4 w-full py-4 font-bold opacity-50">${this.t('cancel')}</button>
                `);
            }

            processPayment() {
                const date = new Date().toLocaleString();
                this.state.history.unshift({ date: date, amount: this.state.fee });
                this.unlock(); // Alert shown inside
                this.closeModal();
            }

            showPremiumModal() {
                this.showModal(`
                    <div class="text-center">
                        <p class="text-6xl mb-4 animate-bounce">ï¿½</p>
                        <h3 class="text-2xl font-black mb-1 text-[#D4AF37] tracking-tight leading-tight">${this.t('premium_headline')}</h3>
                        <p class="text-sm font-bold opacity-80 mb-6 text-[var(--text-color)]">${this.t('premium_subhead')}</p>
                        
                        <div class="text-left bg-gradient-to-br from-[#111] to-[#222] p-5 rounded-2xl border border-[#D4AF37]/30 mb-6 shadow-inner">
                            <p class="text-sm font-bold text-gray-300 leading-relaxed mb-4">
                                ${this.t('premium_body')}
                            </p>
                            <div class="space-y-2 text-xs font-bold text-[#D4AF37]">
                                <div class="flex gap-2 items-center"><span class="text-lg">ğŸ›¡ï¸</span> ${this.t('feat_secure')}</div>
                                <div class="flex gap-2 items-center"><span class="text-lg">ğŸ‘‘</span> ${this.t('feat_gold')}</div>
                                <div class="flex gap-2 items-center"><span class="text-lg">âš™ï¸</span> ${this.t('feat_custom')}</div>
                            </div>
                        </div>

                        <p class="text-xs font-bold opacity-60 mb-4 px-2">${this.t('premium_roi')}</p>

                        <button onclick="app.activatePremium()" class="btn btn-gold w-full text-xl py-4 shadow-2xl border-2 border-white/20 animate-pulse">
                            ${this.t('upgrade_now')}
                        </button>
                        <button onclick="app.closeModal()" class="mt-4 w-full py-3 font-bold opacity-40 text-xs">${this.t('cancel')}</button>
                    </div>
                `);
            }

            activatePremium() {
                this.state.isPremium = true;
                this.toggleTheme('gold'); // Auto switch
                this.closeModal();
                alert("WELCOME TO PREMIUM!");
            }

            // --- UI HELPERS ---

            setDuration(val) {
                this.state.duration = parseInt(val);
                document.getElementById('timer-text').innerText = this.formatDuration(this.state.duration);
            }

            formatDuration(min) {
                if (this.state.lang === 'en') {
                    if (min < 60) return min + "m";
                    const h = Math.floor(min / 60);
                    const m = min % 60;
                    return `${h}h ${m}m`;
                } else {
                    if (min < 60) return min + "åˆ†";
                    const h = Math.floor(min / 60);
                    const m = min % 60;
                    return `${h}æ™‚é–“${m}åˆ†`;
                }
            }

            updateTimerUI(ms) {
                // Update Text
                const totalSec = Math.floor(ms / 1000);
                const h = Math.floor(totalSec / 3600);
                const m = Math.floor((totalSec % 3600) / 60);
                const s = totalSec % 60;

                const el = document.getElementById('timer-text');
                if (el) {
                    if (h > 0) el.innerText = `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                    else el.innerText = `${m}:${s.toString().padStart(2, '0')}`;
                }

                // Update Circle
                const circle = document.getElementById('timer-circle');
                if (circle && this.state.lockEndTime) {
                    // We need original duration to calc progress properly? 
                    // Simplifying: Just make it spin or fill full.
                    // For now, let's keep it full or empty based on state.
                    // To do it right we need 'lockStartTime' in state. 
                    // Skipping complex progress bar logic for V5 MVP to ensure stability.
                }
            }

            completeTutorial() {
                this.state.hasSeenTutorial = true;
                this.save();
                this.closeModal();
            }

            showTutorial() {
                this.showModal(`
                    <div class="text-center space-y-6">
                        <h3 class="text-2xl font-black mb-4">${this.t('tutorial_title')}</h3>
                        
                        <div class="space-y-4 text-left bg-white/5 p-4 rounded-xl border border-white/10">
                            <div>
                                <h4 class="font-bold text-[var(--primary)] flex items-center gap-2">
                                    <span class="bg-[var(--primary)] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">1</span>
                                    ${this.t('tutorial_step1_title')}
                                </h4>
                                <p class="text-sm opacity-80 mt-1 pl-8">${this.t('tutorial_step1_desc')}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-[var(--primary)] flex items-center gap-2">
                                    <span class="bg-[var(--primary)] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">2</span>
                                    ${this.t('tutorial_step2_title')}
                                </h4>
                                <p class="text-sm opacity-80 mt-1 pl-8">${this.t('tutorial_step2_desc')}</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-[var(--danger)] flex items-center gap-2">
                                    <span class="bg-[var(--danger)] text-white w-6 h-6 rounded-full flex items-center justify-center text-xs">3</span>
                                    ${this.t('tutorial_step3_title')}
                                </h4>
                                <p class="text-sm opacity-80 mt-1 pl-8">${this.t('tutorial_step3_desc')}</p>
                            </div>
                        </div>

                        <button onclick="app.completeTutorial()" class="btn btn-primary w-full py-4 shadow-xl text-lg animate-pulse">
                            ${this.t('start_btn')}
                        </button>
                    </div>
                `);
            }

            showLegal() {
                this.showModal(`
                    <div class="text-left">
                        <h3 class="text-2xl font-black mb-4 text-center">${this.t('legal_title')}</h3>
                        <div class="h-64 overflow-y-auto bg-white/5 p-4 rounded-xl border border-white/10 mb-4 prose prose-invert prose-sm">
                            ${this.t('legal_text')}
                        </div>
                        <button onclick="app.closeModal()" class="btn w-full py-3 opacity-80 bg-[var(--card-bg)] border border-[var(--border)]">
                            ${this.t('back')}
                        </button>
                    </div>
                `);
            }

            showModal(html) {
                const con = document.getElementById('modal-container');
                con.innerHTML = `<div class="bg-[var(--card-bg)] w-full max-w-sm rounded-[32px] p-8 shadow-2xl m-4 border border-[var(--border)] relative overflow-hidden">${html}</div>`;
                con.classList.remove('hidden');
            }

            closeModal() {
                document.getElementById('modal-container').classList.add('hidden');
            }
        }

        // --- START ---
        const app = new TradeGuardApp();

    </script>
</body>

</html>